#!/usr/bin/env sh
set -eu

container_mode="${CONTAINER_MODE:-http}"
octane_server="${OCTANE_SERVER:-}"
running_migrations_and_seeders="${RUNNING_MIGRATIONS_AND_SEEDERS:-false}"

initial_setup() {
  echo "Container mode: $container_mode"

  if [ "$running_migrations_and_seeders" = "true" ]; then
    echo "Running migrations and seeding database ..."
    php artisan migrate --isolated --seed --force --no-interaction || \
      php artisan migrate --seed --force --no-interaction
  fi

  php artisan storage:link
  php artisan optimize:clear
  php artisan optimize
}

run_supervisord() {
  conf_basename="$1"
  exec /usr/bin/supervisord -c "/etc/supervisor/conf.d/supervisord.${conf_basename}.conf"
}

start_http() {
  echo "Octane Server: $octane_server"
  case "$octane_server" in
  frankenphp|swoole|roadrunner)
    run_supervisord "$octane_server"
    ;;
  *)
    echo "Invalid Octane server supplied."
    exit 1
    ;;
  esac
}

# Se sono stati passati argomenti, eseguili direttamente
if [ "$#" -gt 0 ]; then
  exec "$@"
fi

case "$container_mode" in
http)
  initial_setup
  start_http
  ;;
horizon)
  initial_setup
  run_supervisord "horizon"
  ;;
reverb)
  initial_setup
  run_supervisord "reverb"
  ;;
scheduler)
  initial_setup
  run_supervisord "scheduler"
  ;;
worker)
  if [ -z "${WORKER_COMMAND:-}" ]; then
    echo "WORKER_COMMAND is undefined."
    exit 1
  fi
  initial_setup
  run_supervisord "worker"
  ;;
*)
  echo "Container mode mismatched."
  exit 1
  ;;
esac
